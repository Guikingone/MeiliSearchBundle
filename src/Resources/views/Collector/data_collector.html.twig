{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% import _self as helper %}

{% block toolbar %}
    {% set indexes, queries = collector.getIndexes(), collector.getQueries() %}

    {% set icon %}
        {{ include('@MeiliSearch/Collector/logo.svg') }}
        <span class="sf-toolbar-value">{{- 'MeiliSearch' -}}</span>
    {% endset %}

    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>{{- 'Indexes' -}}</b>
            <span>{{- indexes['count'] is same as(0) ? 'No index found' : indexes['count'] -}}</span>
        </div>

        <div class="sf-toolbar-info-piece">
            <b>{{ 'Queries count' }}</b>
            <span>{{- queries['count'] is same as(0) ? 'No query made' : queries['count'] -}}</span>
        </div>
    {% endset %}

    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', {link: true}) }}
{% endblock %}

{% block menu %}
    <span class="label {{- collector.indexes|length is same as(0) ? 'disabled' : '' -}}">
        <span class="icon">{{ include('@MeiliSearch/Collector/logo.svg') }}</span>
        <strong>{{- 'MeiliSearch' -}}</strong>
    </span>
{% endblock %}

{% block panel %}
    {% set indexes, queries = collector.getIndexes(), collector.getQueries() %}

    <h2>{{- 'MeiliSearch' -}}</h2>

    <h4>{{ 'Indexes' }}</h4>
    {% if indexes['count'] is same as(0) %}
        <div class="empty">
            <p>{{ 'No index found' }}</p>
        </div>
    {% else %}
        <div class="sf-tabs">
            <div class="tab">
                <h3 class="tab-title">
                    {{- 'Indexes' -}}
                </h3>
                <div class="tab-content">
                    <h3>{{ 'Created indexes' }}</h3>
                    {{ helper.index_table(indexes, 'createdIndexes') }}

                    <h3>{{ 'Fetched indexes' }}</h3>
                    {{ helper.index_table(indexes, 'fetchedIndexes') }}

                    <h3>{{ 'Deleted indexes' }}</h3>
                    {{ helper.index_table(indexes, 'deletedIndexes') }}
                </div>
            </div>
            <div class="tab">
                <h3 class="tab-title">
                    {{- 'Queries' -}}
                </h3>
                <div class="tab-content">
                    {% if queries['count'] is same as(0) %}
                        <div class="empty">
                            <p>{{ 'No queries have been made' }}</p>
                        </div>
                    {% else %}
                        {{ helper.search_table(queries['data']) }}
                    {% endif %}
                </div>
            </div>
            <div class="tab">
                <h3 class="tab-title">
                    {{- 'Documents' -}}
                </h3>
                <div class="tab-content">
{#                    {% set documents = collector.getDocuments() %}#}
{#                    <h3>{{ 'Added documents' }}</h3>#}
{#                    {{ helper.documents_table(indexes, 'addedDocuments') }}#}

{#                    <h3>{{ 'Removed documents' }}</h3>#}
{#                    {{ helper.documents_table(indexes, 'removedDocuments') }}#}

{#                    <h3>{{ 'Retrieved documents' }}</h3>#}
{#                    {{ helper.documents_table(indexes, 'retrievedDocuments') }}#}

{#                    <h3>{{ 'Updated documents' }}</h3>#}
{#                    {{ helper.documents_table(indexes, 'updatedDocuments') }}#}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% macro index_table(array, key) %}
    <table class="{{ class|default('') }}">
        <thead>
        <tr>
            <th scope="col" class="key">
                {{- 'Index' -}}
            </th>
            <th scope="col">
                {{ 'Primary Key' }}
            </th>
        </tr>
        </thead>
        <tbody>
            {% for index in array['data'][key]|sort %}
                <tr>
                    <th>{{- index['uid'] -}}</th>
                    <td>{{- index['primaryKey'] ?? 'Undefined' -}}</td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="2">
                        {{- 'No indexes' -}}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endmacro %}

{% macro search_table(queries) %}
    <table class="{{ class|default('') }}">
        <thead>
            <tr>
                <th scope="col" class="key">
                    {{- 'Index' -}}
                </th>
                <th scope="col">
                    {{- 'Queries count' -}}
                </th>
            </tr>
        </thead>
        <tbody>
            {% for index, queries in queries %}
                <tr>
                    <th>{{- index -}}</th>
                    <th>{{- queries|length -}}</th>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endmacro %}

{% macro documents_table(documents, key) %}
    <table class="{{ class|default('') }}">
        <thead>
        <tr>
            <th scope="col" class="key">
                {{- 'Index' -}}
            </th>
            <th scope="col">
                {{ 'Primary Key' }}
            </th>
        </tr>
        </thead>
        <tbody>
        {% for index in array['data'][key]|sort %}
            <tr>
                <th>{{- index['uid'] -}}</th>
                <td>{{- index['primaryKey'] ?? 'Undefined' -}}</td>
            </tr>
        {% else %}
            <tr>
                <td colspan="2">
                    {{ 'No indexes' }}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endmacro %}
